use std::time::Duration;

use anyhow::Result;
use redis::{
    from_redis_value,
    streams::{StreamRangeReply, StreamReadOptions, StreamReadReply},
    AsyncCommands, Client, ToRedisArgs,
};
use serde_json::Value;
use tokio::time::sleep;

// with flavor it runs on single thread with async IO
#[tokio::main(flavor = "current_thread")]
async fn main() -> Result<()> {
    let client = Client::open("redis://localhost:6379")?;
    let mut con = client.get_tokio_connection().await?;

    // set, get
    con.set("test", "hello").await?;
    let result: String = con.get("test").await?;

    println!("{}", result);

    // Redis queue
    con.xadd(
        "streamer",
        "*",
        &[("name", "name-01"), ("title", "title 01")],
    )
    .await?;

    let len: i32 = con.xlen("streamer").await?;
    print!("{}", len);

    // xrevrange the read stream
    let result: Option<StreamRangeReply> =
        con.xrevrange_count("streamer", "+", "-", 10).await?;

    if let Some(reply) = result {
        for stream_id in reply.ids {
            println!("Stream entity: {}", stream_id.id);
            for (name, value) in stream_id.map.iter() {
                println!(" ->> {}: {}", name, from_redis_value::<String>(value)?);
            }
            println!();
        }
    }

    // blocking xread: async for caller but blocking for redis
    tokio::spawn(async {
        let client = Client::open("redis://localhost:6379").unwrap();
        let mut con = client.get_tokio_connection().await.unwrap();
        loop {
            let opts = StreamReadOptions::default().count(1).block(0);
            let result: Option<StreamReadReply> = con
                .xread_options(&["streamer"], &["$"], &opts)
                .await
                .unwrap();
            if let Some(reply) = result {
                for stream_key in reply.keys {
                    println!("->> xread block: {}", stream_key.key);
                    for stream_id in stream_key.ids {
                        println!("  ->> StreamId: {:?}", stream_id);
                    }
                }
                println!();
            }
        }
    });

    //? Item-cache Store key-value (collection-itemid -> vector f64)
    let key = "postings_500K-106067015";
    let value = serde_json::to_string(&vec![
        0.009988062,
        -0.030212486,
        0.01176497,
        0.0017722283,
        0.0140239615,
        0.049521834,
        -0.037339136,
        -0.017412685,
        0.03714765,
        -0.011546484,
        0.009943127,
        0.052031953,
        0.06688436,
        -0.002978411,
        0.025868772,
        -0.0044929427,
        -0.02387325,
        -0.03484404,
        0.0074949553,
        -0.056819703,
        -0.020837562,
        -0.023128934,
        -0.065166846,
        0.017867388,
        -0.01163579,
        -0.025251472,
        -0.009707197,
        0.009489928,
        -0.017865315,
        0.055594202,
        -0.007778794,
        0.003413078,
        -0.009354935,
        -0.002250896,
        0.008256787,
        0.026476866,
        -0.044684228,
        -0.023726853,
        0.0482041,
        0.024064522,
        0.04024925,
        -0.016975183,
        -0.0019630312,
        0.014405689,
        -0.047844812,
        -0.0062573114,
        0.030113658,
        -0.055211924,
        -0.020559967,
        0.020694975,
        0.025252845,
        -0.001864031,
        0.02231468,
        -0.019388448,
        0.025814028,
        -0.017805833,
        -0.007775927,
        -0.01833432,
        -0.0013680925,
        0.0040930146,
        -0.008689483,
        0.04896053,
        0.016645832,
        0.0065754023,
        -0.05714884,
        -0.039005768,
        -0.033853453,
        -0.025462722,
        -0.04298696,
        0.019934334,
        0.0026149652,
        0.06460107,
        -0.0032463318,
        0.034802794,
        0.042254977,
        0.036916826,
        0.09934874,
        0.043123934,
        -0.09011309,
        -0.01081492,
        0.03773321,
        0.014155691,
        0.04633971,
        0.0049043414,
        0.015386679,
        0.027279705,
        0.024979757,
        -0.014730573,
        0.04098791,
        -0.06404769,
        -0.009422462,
        -0.032549582,
        0.017235363,
        0.0016616961,
        -0.03696149,
        0.037766967,
        0.006241537,
        0.0064576394,
        0.026311973,
        -0.026927348,
        -0.02468014,
        -0.013574603,
        0.039468188,
        -0.013062032,
        0.033385888,
        0.03264117,
        -0.032396376,
        0.046583615,
        -0.0012298635,
        -0.016807439,
        0.04286377,
        -0.0063144355,
        0.036085207,
        0.016741563,
        -0.00788626,
        0.0057248855,
        -0.02331741,
        0.07773747,
        -0.03948841,
        0.015399117,
        -0.039891094,
        -0.008111643,
        0.021174546,
        0.07147779,
        -0.021638907,
        -0.034199093,
        0.0026464413,
        -0.049220104,
        0.03189002,
        -0.04641218,
        0.017715648,
        -0.03900803,
        -0.019326793,
        -0.022998072,
        -0.077219516,
        0.0103786215,
        -0.004024897,
        -0.08066616,
        -0.00096513453,
        0.04583755,
        0.03922679,
        0.028054412,
        -0.08410452,
        -0.022941483,
        -0.086910665,
        0.00017879606,
        -0.009177626,
        0.047087632,
        0.005781629,
        0.01123338,
        -0.025166685,
        0.04409514,
        0.037093565,
        0.05818611,
        0.037442647,
        0.015653023,
        -0.0097144805,
        -0.008051809,
        -0.012984742,
        0.004219768,
        0.012408581,
        0.023679955,
        -0.044000298,
        0.023663642,
        -0.09336095,
        -0.010179594,
        0.010479578,
        0.02618714,
        0.02851872,
        0.03764593,
        -0.026017727,
        0.028989488,
        0.03802455,
        0.018176267,
        0.014922722,
        -0.012294843,
        0.006519541,
        -0.05865669,
        -0.012625244,
        -0.015598951,
        -0.028981278,
        -0.0053859185,
        -0.020828234,
        -0.006924957,
        0.005571206,
        -0.029945564,
        0.043114837,
        0.059642915,
        0.0018338048,
        -0.054246694,
        -0.008786429,
        -0.0066722953,
        0.018766107,
        -0.04321256,
        0.05424621,
        -0.022619212,
        -0.019566208,
        0.009613363,
        -0.009773252,
        -0.038473967,
        0.018337214,
        -0.008292718,
        -0.036865436,
        -0.0063491045,
        0.0010752191,
        -1.6536236e-05,
        -0.0009911042,
        -0.055195123,
        0.03892705,
        0.07776095,
        -0.0018248245,
        0.01567783,
        -0.02245778,
        0.014976228,
        0.03961106,
        0.008997416,
        -0.04933457,
        -0.07068696,
        0.038434234,
        0.007769534,
        -0.024352713,
        -0.03321125,
        -0.013595137,
        -0.043463625,
        -0.008547701,
        0.049392343,
        -0.01677053,
        0.007159989,
        -0.039257612,
        0.0010765098,
        0.018724272,
        -0.02485907,
        -0.026601026,
        0.012017334,
        0.015401311,
        0.0027807627,
        -0.0017840513,
        -0.07178092,
        0.0015777737,
        -0.008517273,
        0.020715704,
        0.04272023,
        0.036677983,
        0.022635095,
        -0.02915376,
        -0.019351453,
        0.0060054534,
        0.03950262,
        0.0073922016,
        0.024227934,
        -0.03431337,
        -0.055039898,
        0.006864617,
        -0.06185179,
        0.019831713,
        -0.062910326,
        0.048312645,
        -0.002041841,
        0.016471235,
        -0.051584363,
        0.00054999365,
        -0.111542255,
        0.026873143,
        0.023678878,
        -0.06280727,
        0.010882867,
        0.004798061,
        -0.02254009,
        -0.010307759,
        -0.035193823,
        -0.041266464,
        0.0021500927,
        -0.010201052,
        -0.007145725,
        -0.0032617324,
        0.020380214,
        -0.030788759,
        0.02708162,
        0.060706943,
        0.006769542,
        0.0027023978,
        0.0006372215,
        0.023008328,
        0.07352487,
        0.017335065,
        -0.043237165,
        -0.006414845,
        -0.03207249,
        -0.0013251724,
        -0.010458361,
        -0.06154376,
        -0.006357661,
        0.056283545,
        0.0336187,
        -0.0059027383,
        0.06377169,
        0.012415482,
        -0.006291581,
        0.032708824,
        -0.0077577485,
        0.012076776,
        0.04299862,
        -0.03509244,
        -0.010892197,
        -0.011288224,
        0.008008159,
        0.015853086,
        -0.0057794964,
        0.047326934,
        0.030061323,
        -0.0605354,
        -0.010741141,
        -0.018885665,
        0.045249462,
        -0.01343637,
        0.0139467195,
        0.01640571,
        0.030805584,
        -0.011608537,
        -0.027128866,
        -0.03611746,
        0.007258723,
        -0.01335274,
        0.021429852,
        0.01474332,
        0.01748492,
        0.009151536,
        0.024830319,
        -0.055758853,
        0.06952924,
        -0.010713342,
        0.010089362,
        -0.056869075,
        -0.027434502,
        0.027230952,
        -0.026624313,
        -0.027133659,
        -0.037008062,
        0.055944555,
        -0.039076757,
        0.020956233,
        -0.030262506,
        0.035473857,
        -0.0030320706,
        0.012476674,
        -0.018140947,
        -0.018605214,
        0.031700008,
        0.0942291,
        0.020039905,
        -0.09656531,
        0.017635113,
        0.035430863,
        0.052285712,
        0.009680547,
        -0.033581328,
        -0.0053543155,
        0.039594155,
        0.013642128,
        -0.0046805963,
        -0.012195067,
        0.0063819173,
        0.014886875,
        -0.023138627,
        0.031525508,
        -0.051677242,
        0.041065525,
        0.004956747,
        -0.0036630013,
        0.016107922,
        0.0104856165,
        0.1884539,
        -0.036329273,
        0.014629365,
        0.03158942,
        0.022350136,
        -0.016157046,
        -0.08889216,
        0.019205144,
        -0.031692095,
        0.011888476,
        -0.10830333,
        -0.049591452,
        -0.018013017,
        -0.008740311,
        -0.024329964,
        -0.01973439,
        -0.016957281,
        -0.004158908,
        -0.0005959654,
        -0.043717977,
        -0.00060784403,
        -0.0041469373,
        0.006148495,
        -0.0011355927,
        0.035197943,
        -0.04252101,
        0.027096197,
        0.007276681,
        -0.005856725,
        0.03253467,
        0.013006036,
        0.07318879,
        -0.04314811,
        -0.010079321,
        -0.047051717,
        -0.00073155604,
        -0.026072295,
        -0.00015693897,
        0.010386691,
        -0.048606087,
        0.003375962,
        0.0052242153,
        0.077528894,
        -0.014807767,
        0.0031875179,
        -0.035584584,
        -0.034625065,
        -0.0017914051,
        0.06450141,
        0.007707924,
        -0.0029119172,
        0.020544795,
        -0.1472524,
        0.000570766,
        -0.008275744,
        0.03224045,
        -0.024478622,
        -0.049605664,
        0.002817806,
        -0.07336711,
        -0.0029685406,
        -0.050891846,
        0.008257242,
        0.029176617,
        -0.03802581,
        -0.04405481,
        -0.014730815,
        -0.0052229855,
        0.030010281,
        -0.0136244,
        0.015300202,
        0.0064982837,
        0.122113615,
        -0.043680232,
        -0.026972078,
        0.0067593353,
        0.025622727,
        -0.041941777,
        0.0014781714,
        0.043057334,
        -0.07394602,
        -0.0052835406,
        -0.05946136,
        -0.051362857,
        -0.012556979,
        0.049262743,
        -0.010994656,
        0.022285499,
        -0.10026244,
        -0.0023043007,
        -0.02773354,
        -0.025857344,
        0.04605467,
        -0.059044298,
        -0.06456909,
        -0.04223915,
        0.017057925,
        0.04957363,
        -0.01204556,
        0.03505308,
        0.084070496,
        0.047545988,
        -0.05976492,
        -0.0070281215,
        -0.02983726,
        0.015481468,
        -0.009326782,
        0.020826053,
        -0.0015267595,
        -7.7491895e-05,
        0.022099366,
        0.01892993,
        -0.0020506126,
        -0.031441864,
        -0.06763691,
        0.0010140203,
        -0.03380984,
        0.0019362277,
        -0.0052424665,
        0.017113786,
        0.034696028,
        0.020616554,
        -0.09356071,
        -0.04028597,
        -0.034944966,
        0.003092533,
        -0.07501425,
        0.07298494,
        0.06132147,
        -0.040012345,
        -0.014766728,
        -0.015973587,
        -0.028407106,
        -0.03349454,
        0.0006656153,
        9.6237265e-05,
        0.011210952,
        -0.023593754,
        0.0074755787,
        0.0477865,
        0.046234988,
        0.011655676,
        0.029637128,
        -0.015312054,
        0.070250995,
        0.06666151,
        0.0102612125,
        -0.031040443,
        0.046533436,
        0.045376796,
        0.016188106,
        0.06110322,
        -0.072032146,
        0.053001165,
        -0.031835556,
        0.0211236,
        -0.007859735,
        0.024016684,
        0.0133761875,
        -0.03127654,
        0.031097112,
        -0.017875977,
        0.040200576,
        -0.024949552,
        -0.014268433,
        -0.03891294,
        -0.03455897,
        0.017903382,
        -0.033031847,
        -0.0037570535,
        0.0041823774,
        0.0060190014,
        0.012590203,
        0.02016953,
        0.002130262,
        -0.035555348,
        0.0013520411,
        -0.019256799,
        0.022505093,
        0.03351683,
        -0.001869896,
        0.018222101,
        -0.03413082,
        0.0052308873,
        0.0073162634,
        -0.03350897,
        -0.025671482,
        0.023470294,
        -0.008991891,
        0.0056478987,
        0.0072714044,
        0.010814144,
        0.034103684,
        -0.03627608,
        0.03548896,
        -0.03063092,
        0.016508887,
        -0.040804364,
        -0.03890034,
        -0.01411896,
        0.047579262,
        0.018616507,
        0.058728192,
        -0.0418496,
        -0.038125608,
        -0.05832949,
        0.048275013,
        0.0035716966,
        0.026579797,
        -0.0057327393,
        -0.019328704,
        0.020074526,
        0.02264527,
        0.026920363,
        0.029551843,
        0.00034458557,
        -0.024687745,
        -0.054902922,
        0.020268707,
        0.03381832,
        0.041740138,
        -0.11107588,
        -0.013510335,
        0.0036972172,
        0.036898654,
        0.01733849,
        -0.010533499,
        0.034954146,
        -0.015557357,
        0.028026603,
        -0.10658146,
        -0.04985043,
        -0.06780425,
        0.042185627,
        -0.0011016002,
        0.013818851,
        -0.0692203,
        0.020208262,
        0.02669358,
        0.020859448,
        -0.04459458,
        -0.01312315,
        -0.011282765,
        0.05689169,
        -0.016004033,
        0.008057552,
        0.010742096,
        0.017230544,
        -0.055639,
        0.07830368,
        0.02585044,
        0.003644735,
        0.0116653135,
        -0.019238126,
        0.020173298,
        0.00993434,
        -0.04643781,
        0.023453468,
        -0.0314494,
        0.007694127,
        0.0066560516,
        0.01509573,
        -0.03484183,
        0.033791963,
        -0.014627479,
        0.0046369745,
        0.01288895,
        0.015476623,
        -0.022382656,
        -0.059248846,
        -0.011116413,
        0.008576694,
        -0.025047613,
        0.0030056594,
        0.023994582,
        0.051096663,
        0.059700258,
        -0.11040726,
        -0.03646205,
        0.04502537,
        0.023450306,
        0.045958348,
        -0.01245645,
        0.00986488,
        0.043477356,
        -0.021838944,
        0.04386712,
        -0.0030744472,
        0.1009584,
        0.017221767,
        0.04198959,
        0.038623057,
        0.012280521,
        0.021842593,
        0.03606884,
        -0.031443935,
        -0.035290875,
        0.007087919,
        0.019070612,
        0.021337338,
        0.061604492,
        0.0036655148,
        -0.018724848,
        0.027208472,
        0.033839293,
        -0.035304982,
        0.011835635,
        0.024039458,
        -0.07522187,
        0.0062380107,
        0.020046609,
        -0.028909009,
        -0.014470354,
        0.008100292,
        0.009490637,
        -0.04960276,
        0.02990012,
        -0.0010979743,
        0.0054903026,
        -0.010444413,
        0.051059943,
        -0.03510197,
        0.015742017,
        0.01943208,
        -0.023794074,
        0.021820141,
        0.013330139,
        -0.0048752395,
        0.041406803,
        0.018526133,
        -0.071023636,
        0.015026233,
        0.028115766,
        0.05879544,
        0.012909444,
        -0.03283866,
        -0.058476586,
        -0.011683014,
        0.011988976,
        0.11289316,
        -0.003291084,
        -0.012045573,
        -0.038172506,
        0.04898158,
        -0.044579502,
        -0.025007917,
        -0.009398436,
        -0.039689023,
        0.051015038,
        0.004154943,
        0.046360493,
        0.0020369098,
        -0.034375183,
        0.020872936,
        0.038428903,
        0.014477266,
        -0.0031549113,
        -0.009823264,
        -0.010037886,
        -0.011438786,
        -0.0883847,
        0.020799683,
        0.0030290477,
        0.020397712,
        -0.04938938,
        -0.017967578,
        0.057696737,
        -0.039053604,
        0.03503103,
        -0.034437962,
        -0.06962153,
        0.008040366,
        0.013584368,
        0.014267194,
        -0.014664105,
        0.050812,
        0.010143123,
        0.024465377,
        -0.026580485,
        0.026489949,
        0.006659278,
        0.0021905839,
        0.00012097439,
        0.03387714,
        0.0035294944,
        -0.047991857,
        0.07746417,
        0.02437888,
        0.006789479,
        0.00016419745,
        -0.019680051,
        -0.010593506,
        0.017618194,
        0.030155817,
        0.03508318,
        0.031929698,
        -0.06986468,
    ])?;

    let result2 = con.set_ex(key, value, 3600).await?;

    println!("{:?}", &result2);

    // get the vector
    let result3: String = con.get(key.to_string()).await?;

    println!("{:?}", serde_json::from_str::<Value>(result3.as_str()));

    // Add some stream entries; sleep as we're doing it from the same process
    sleep(Duration::from_millis(100)).await;
    con.xadd(
        "streamer",
        "*",
        &[("name", "name-02"), ("title", "title 02")],
    )
    .await?;
    sleep(Duration::from_millis(1000)).await;
    con.xadd(
        "streamer",
        "*",
        &[("name", "name-02"), ("title", "title 03")],
    )
    .await?;

    // wait and cleanup
    // con.del("test").await?;
    // con.del("streamer").await?;

    // println!("{:?}", con.get("test").await?);

    Ok(())
}
